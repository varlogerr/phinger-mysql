<?xml version="1.0" encoding="UTF-8" ?>

<project name="phinger_mysql">
    <target name="vlog:mysql:_init">
        <mkdir dir="${phinger.mysql.dump_dir}" />
    </target>

    <!--
    Required properties (defaults):
        dbhost           ("127.0.0.1")
        dbport           (3306)
        dbname           ("acme")
        dbuser           ("root")
        dbpass           ("")
        dumputil_path    ("/usr/bin/mysqldump")
        dump_dir         ("./backup/sql")
        dump_no_comments (true)
        dump_no_locks    (true)
    -->
    <target name="phinger:mysql:dump-create" description="Dump database to an sql file"
            depends="vlog:mysql:_init">
        <property name="phinger.mysql._command_part" value="" />

        <if>
            <not>
                <equals arg1="${phinger.mysql.dbpass}" arg2=""/>
            </not>
            <then>
                <property
                        name="phinger.mysql._command_part"
                        value="${phinger.mysql._command_part}-p${phinger.mysql.dbpass}"
                        override="true"
                />
            </then>
        </if>

        <if>
            <equals arg1="${phinger.mysql.dump_no_comments}" arg2="true" />
            <then>
                <property
                        name="phinger.mysql._command_part"
                        value="${phinger.mysql._command_part} --skip-comments"
                        override="true"
                />
            </then>
        </if>

        <if>
            <equals arg1="${phinger.mysql.dump_no_locks}" arg2="true" />
            <then>
                <property
                        name="phinger.mysql._command_part"
                        value="${phinger.mysql._command_part} --skip-add-locks"
                        override="true"
                />
            </then>
        </if>

        <exec
                command="${phinger.mysql.dumputil_path} -u${phinger.mysql.dbuser} ${phinger.mysql._command_part}
                         -h${phinger.mysql.dbhost}  ${phinger.mysql.dbname} --port=${phinger.mysql.dbport} &gt; ${phinger.mysql.dump_dir}/dump.sql"
                checkreturn="true"
                passthru="true"
        />
    </target>
</project>
